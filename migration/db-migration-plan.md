# 数据库迁移计划

## 迁移目标

从 Supabase 迁移到轻量级 PostgreSQL 数据库

## 当前架构分析

### Supabase 配置
- URL: https://oiatqeymovnyubrnlmlu.supabase.co
- 匿名密钥: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
- 数据库: PostgreSQL 14+
- 认证: Supabase Auth
- 存储: Supabase Storage (当前使用 ImgBB)

### 现有数据表
1. **games** - 游戏内容主表
2. **categories** - 游戏分类表  
3. **admin_settings** - 管理员设置表（当前在localStorage）

## 迁移方案

### 阶段一：环境准备
- [ ] 选择新的 PostgreSQL 提供商
- [ ] 设置新数据库实例
- [ ] 配置连接和安全设置
- [ ] 创建迁移工具

### 阶段二：Schema 迁移
- [ ] 导出现有数据库结构
- [ ] 在新数据库中重建 Schema
- [ ] 添加索引和约束
- [ ] 设置数据验证规则

### 阶段三：数据迁移
- [ ] 导出现有数据
- [ ] 数据清洗和验证
- [ ] 批量导入新数据库
- [ ] 验证数据完整性

### 阶段四：应用改造
- [ ] 替换 Supabase 客户端
- [ ] 实现新的认证系统
- [ ] 更新 API 接口
- [ ] 测试所有功能

### 阶段五：上线切换
- [ ] 功能测试
- [ ] 性能测试
- [ ] 备份策略
- [ ] 生产部署

## 推荐的 PostgreSQL 服务商

### 1. Neon (推荐)
- **优势**: 
  - 免费额度: 512MB RAM, 3GB 存储
  - 自动休眠节省成本
  - 分支功能适合开发
  - Vercel 集成
- **成本**: 免费层 → $19/月
- **适合**: 轻量级项目

### 2. Railway
- **优势**:
  - 简单部署
  - 与 GitHub 集成
  - 自动扩展
- **成本**: $5/月起
- **适合**: 全栈应用

### 3. PlanetScale
- **优势**:
  - MySQL 兼容
  - 分支功能
  - 企业级可靠性
- **成本**: $29/月起
- **适合**: 需要 MySQL 的项目

### 4. Supabase 自托管
- **优势**:
  - 完全控制
  - 成本可控
  - 功能完整
- **成本**: VPS $10-50/月
- **适合**: 有运维能力的团队

## 迁移时间表

| 阶段 | 预计时间 | 主要任务 |
|------|----------|----------|
| 阶段一 | 1周 | 环境搭建 |
| 阶段二 | 1周 | Schema 设计 |
| 阶段三 | 1周 | 数据迁移 |
| 阶段四 | 2周 | 应用改造 |
| 阶段五 | 1周 | 测试上线 |

**总计: 6周**

## 风险评估

### 高风险
- **数据丢失**: 迁移过程中数据损坏
- **功能不兼容**: 认证系统重构风险
- **性能问题**: 新数据库性能不达预期

### 中风险
- **开发时间超期**: 复杂度被低估
- **用户体验中断**: 切换期间服务不稳定

### 低风险
- **成本控制**: 新方案成本超预算

## 回滚策略

1. **保持原 Supabase 环境**作为备份
2. **实现双写机制**，同时写入新旧数据库
3. **快速切换开关**，可在 1 分钟内回滚
4. **数据同步脚本**，确保回滚时数据一致

## 成功指标

- [ ] 数据迁移 100% 完整性
- [ ] 应用功能 100% 正常
- [ ] 性能提升 ≥50%
- [ ] 成本降低 ≥60%
- [ ] 停机时间 <30分钟

## 下一步行动

1. **选择数据库服务商** (推荐 Neon)
2. **创建迁移脚本**
3. **搭建测试环境**
4. **开始 Schema 设计**